<!-- templates/workspace.html (Combined Final Version with Topic Generator) -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ project_name }} - AI Study Assistant</title>
    <style>
        body, html { margin: 0; padding: 0; font-family: sans-serif; height: 100%; background-color: #f7f7f7; }
        * { box-sizing: border-box; }
        .container { display: flex; height: 100vh; }
        .panel { padding: 20px; border-right: 1px solid #ddd; background-color: #fff; display: flex; flex-direction: column; }
        .panel h2, .panel h3 { margin-top: 0; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .left-panel { flex: 1; min-width: 250px; }
        #source-list { list-style-type: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        #source-list li { padding: 10px; cursor: pointer; border-radius: 5px; margin-bottom: 5px; border: 1px solid transparent; }
        #source-list li:hover { background-color: #f0f0f0; }
        #source-list li.selected { background-color: #007bff; color: white; border-color: #0056b3; }
        #upload-form { margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; }
        #upload-form button { width: 100%; padding: 10px; }
        .center-panel { flex: 2; border-right: none; }
        .chat-window { flex-grow: 1; overflow-y: auto; border: 1px solid #ccc; padding: 10px; border-radius: 5px; margin-bottom: 15px; display: flex; flex-direction: column; }
        .chat-message { margin-bottom: 10px; max-width: 80%; }
        .user-message { align-self: flex-end; }
        .user-message p { background-color: #007bff; color: white; padding: 10px; border-radius: 15px 15px 0 15px; display: inline-block; }
        .bot-message { align-self: flex-start; }
        .bot-message p { background-color: #e9e9eb; padding: 10px; border-radius: 15px 15px 15px 0; display: inline-block; white-space: pre-wrap; }
        #chat-form { display: flex; }
        #chat-input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px 0 0 5px; }
        #chat-form button { padding: 10px 15px; border: none; background-color: #007bff; color: white; border-radius: 0 5px 5px 0; cursor: pointer; }
        .right-panel { flex: 1.5; min-width: 300px; border-right: none; }
        #scratchpad { flex-grow: 1; border: 1px solid #ccc; border-radius: 5px; padding: 15px; overflow-y: auto; }
        .action-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .action-buttons button { flex-grow: 1; padding: 12px; }
        #copy-note-btn { background-color: #28a745; color: white; border: none; }
        #copy-note-btn:hover { background-color: #218838; }
        .loader { text-align: center; padding: 10px; display: none; }

        /* --- NEW STYLES for Topic Generator --- */
        #topic-note-form { 
            margin-top: 20px; 
            border-top: 1px solid #eee; 
            padding-top: 20px;
        }
        #topic-input {
            width: 100%;
            height: 60px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 10px;
            font-family: inherit;
        }
        #generate-topic-note-btn {
            width: 100%;
            padding: 12px;
            background-color: #ffc107; /* A yellow/gold color */
            color: black;
            border: none;
            cursor: pointer;
        }
        #generate-topic-note-btn:hover {
            background-color: #e0a800;
        }

        .panel {
            position: relative;
            /* This prevents panels from getting too small during resize */
            min-width: 150px; 
        }

        /* Style for the resizer handles */
        .resizer {
            flex: 0 0 10px; /* The resizer has a fixed width of 10px */
            background-color: #eef0f2;
            cursor: col-resize; /* Cursor indicates horizontal resizing */
            display: flex;
            align-items: center;
            justify-content: center;
            border-left: 1px solid #ddd;
            border-right: 1px solid #ddd;
            z-index: 5; /* Ensure it's above panels */
        }
        .resizer::after {
            content: 'â‹®';
            font-size: 14px;
            color: #888;
        }

        /* Style for the drawer toggle buttons */
        .drawer-toggle {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 40px;
            background-color: #007bff;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0 5px 5px 0;
            cursor: pointer;
            z-index: 10;
            font-weight: bold;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        }

        /* Position the toggles on the correct side */
        .left-panel .drawer-toggle {
            right: -20px; /* Sits on the outside edge of the left panel */
        }
        .right-panel .drawer-toggle {
            left: -20px; /* Sits on the outside edge of the right panel */
            border-radius: 5px 0 0 5px;
        }

        /* The "collapsed" state for a panel */
        .panel.collapsed {
            flex: 0 0 0 !important; /* The magic: makes the panel take up no space */
            min-width: 0;
            padding: 0;
            border: none;
            overflow: hidden; /* Hide all content when collapsed */
        }

        /* When a panel is collapsed, we need to hide its resizer too */
        .panel.collapsed + .resizer {
            display: none;
        }

        /* This class prevents ugly text selection during drag */
        body.resizing {
            cursor: col-resize;
            user-select: none; /* A modern CSS property for this */
            -webkit-user-select: none; /* For older browsers */
            -moz-user-select: none;
        }

        
    </style>
</head>
<body>
    <input type="hidden" id="project-id" value="{{ project_id }}">
    <a href="/" style="position: absolute; top: 5px; left: 5px; text-decoration: none; padding: 5px 10px; background: #eee; border-radius: 5px; color: #333;">&larr; Back to Projects</a>
    
    <div class="container">
        <!-- Left Panel (Unchanged) -->
        <div class="panel left-panel">

            <div class="drawer-toggle" data-target="left-panel">&larr;</div>

            <h2>Sources for {{ project_name }}</h2>
            <ul id="source-list"></ul>
            <div class="loader" id="source-loader">Loading sources...</div>
            <form id="upload-form">
                <input type="file" id="pdf-files" name="pdfs" accept=".pdf" required multiple>
                <button type="submit">Upload & Process PDF(s)</button>
            </form>
            <div class="loader" id="upload-loader"></div>
        </div>

        <div class="resizer" data-resizer-type="x"></div>
        
        <!-- Center Panel (Unchanged) -->
        <div class="panel center-panel">
            <h2>Chat</h2>
            <div class="chat-window" id="chat-window"><div class="bot-message"><p>Hello! Ask a question to search all sources, or select a source on the left to focus your questions.</p></div></div>
            <form id="chat-form">
                <input type="text" id="chat-input" placeholder="Ask a question...">
                <button type="submit">Send</button>
            </form>
        </div>

        <div class="resizer" data-resizer-type="x"></div>

        <!-- Right Panel (MODIFIED to include Topic Generator) -->
        <div class="panel right-panel">

            <div class="drawer-toggle" data-target="right-panel">&rarr;</div>

            <h2>Scratchpad</h2>
            <div id="scratchpad"><p>Select a source and click "Show Source Note", or use the tool below to create a custom note from all sources.</p></div>
            <div class="action-buttons">
                <button id="generate-note-btn" disabled>Show Source Note</button>
                <button id="copy-note-btn" disabled>Copy Note</button>
            </div>
            <div class="loader" id="note-loader"></div>

            <!-- --- NEW: TOPIC NOTE GENERATOR FORM --- -->
            <form id="topic-note-form">
                <h3>Generate Custom Note</h3>
                <textarea id="topic-input" placeholder="Enter a topic or instruction... e.g., 'Create a list of all key definitions' or 'Summarize the main arguments about photosynthesis'"></textarea>
                <button type="submit" id="generate-topic-note-btn">Generate from All Sources</button>
            </form>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // === DOM Element References (with new elements added) ===
        const sourceList = document.getElementById('source-list');
        const uploadForm = document.getElementById('upload-form');
        const pdfInput = document.getElementById('pdf-files');
        const uploadLoader = document.getElementById('upload-loader');
        const sourceLoader = document.getElementById('source-loader');
        const scratchpad = document.getElementById('scratchpad');
        const generateNoteBtn = document.getElementById('generate-note-btn');
        const copyNoteBtn = document.getElementById('copy-note-btn');
        const noteLoader = document.getElementById('note-loader');
        const chatWindow = document.getElementById('chat-window');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        // NEW: Topic generator elements
        const topicNoteForm = document.getElementById('topic-note-form');
        const topicInput = document.getElementById('topic-input');

        // === STATE MANAGEMENT ===
        const projectId = document.getElementById('project-id').value;
        let selectedSourceId = null;
        let chatHistory = [];
        let noteIsVisible = false;

        // === Core Functions ===
        async function loadSources() {
            sourceLoader.style.display = 'block';
            sourceList.innerHTML = '';
            try {
                const response = await fetch(`/get-sources/${projectId}`); 
                const sources = await response.json();
                if (sources && sources.length > 0) {
                    sources.forEach(source => {
                        const li = document.createElement('li');
                        li.textContent = source.filename;
                        li.dataset.sourceId = source.id;
                        sourceList.appendChild(li);
                    });
                } else { sourceList.innerHTML = '<p>No sources uploaded yet.</p>'; }
            } catch (error) { sourceList.innerHTML = '<p>Error loading sources.</p>'; }
            sourceLoader.style.display = 'none';
        }

        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const files = pdfInput.files;
            if (files.length === 0) return;
            uploadLoader.textContent = `Processing ${files.length} file(s)...`;
            uploadLoader.style.display = 'block';
            const formData = new FormData();
            for (let i = 0; i < files.length; i++) { formData.append('pdfs', files[i]); }
            try {
                const response = await fetch(`/upload-source/${projectId}`, { 
                method: 'POST',
                body: formData
                });
                const result = await response.json();
                if (result.success) { await loadSources(); } else { alert(`Error: ${result.error}`); }
            } catch (error) { alert('An unexpected error during upload.'); }
            uploadLoader.style.display = 'none';
            uploadForm.reset();
        });
        
        sourceList.addEventListener('click', (e) => {
            if (e.target && e.target.tagName === 'LI') {
                const currentSelected = sourceList.querySelector('.selected');
                
                noteIsVisible = false;
                copyNoteBtn.disabled = true;
                copyNoteBtn.textContent = 'Copy Note';
                scratchpad.innerHTML = '<p>Select a source and click "Show Source Note", or use the tool below to create a custom note from all sources.</p>';
                generateNoteBtn.disabled = true;
                resetChat();

                if (currentSelected && currentSelected === e.target) {
                    currentSelected.classList.remove('selected');
                    selectedSourceId = null;
                    chatInput.placeholder = "Ask a question (all sources)...";
                    addMessage("You are now chatting with all sources.", "bot");
                } else {
                    if (currentSelected) { currentSelected.classList.remove('selected'); }
                    e.target.classList.add('selected');
                    selectedSourceId = e.target.dataset.sourceId;
                    generateNoteBtn.disabled = false;
                    chatInput.placeholder = `Ask about ${selectedSourceId}...`;
                    addMessage(`Conversation started for ${selectedSourceId}.`, "bot");
                }
            }
        });

        generateNoteBtn.addEventListener('click', async () => {
            if (!selectedSourceId) return;
            noteLoader.textContent = 'Fetching source note...';
            noteLoader.style.display = 'block';
            scratchpad.innerHTML = '';
            
            copyNoteBtn.disabled = true; 
            copyNoteBtn.textContent = 'Copy Note';
            noteIsVisible = false;

            const response = await fetch(`/get-note/${projectId}/${encodeURIComponent(selectedSourceId)}`);
            const data = await response.json();
            noteLoader.style.display = 'none';

            if (data.note_html) { 
                scratchpad.innerHTML = data.note_html; 
                copyNoteBtn.disabled = false;
                noteIsVisible = true;
            }
            else { scratchpad.innerHTML = `<p>Error: ${data.error || 'Could not fetch note.'}</p>`; }
        });
        
        copyNoteBtn.addEventListener('click', () => {
            if (!noteIsVisible) return;
            const htmlContent = scratchpad.innerHTML;
            if (typeof ClipboardItem !== 'undefined') {
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const clipboardItem = new ClipboardItem({ 'text/html': blob });
                navigator.clipboard.write([clipboardItem]).then(() => {
                    copyNoteBtn.textContent = 'Copied!';
                    setTimeout(() => { copyNoteBtn.textContent = 'Copy Note'; }, 2000);
                }).catch(err => {
                    console.error('Failed to copy HTML: ', err);
                    copyNoteBtn.textContent = 'Copy Failed';
                });
            } else {
                navigator.clipboard.writeText(scratchpad.innerText).then(() => {
                    copyNoteBtn.textContent = 'Copied (Text)!';
                    setTimeout(() => { copyNoteBtn.textContent = 'Copy Note'; }, 2000);
                }).catch(err => {
                    console.error('Failed to copy text: ', err);
                    copyNoteBtn.textContent = 'Copy Failed';
                });
            }
        });
        
        // --- NEW: Event listener for the topic note form ---
        topicNoteForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const topic = topicInput.value.trim();
            if (!topic) return;

            noteLoader.textContent = 'Generating custom note...';
            noteLoader.style.display = 'block';
            scratchpad.innerHTML = '';
            copyNoteBtn.disabled = true;
            noteIsVisible = false;

            try {
                const response = await fetch(`/generate-topic-note/${projectId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic: topic })
                });
                const data = await response.json();

                if (data.note_html) {
                    scratchpad.innerHTML = data.note_html;
                    copyNoteBtn.disabled = false;
                    noteIsVisible = true;
                } else {
                    scratchpad.innerHTML = `<p>Error: ${data.error || 'Could not generate note.'}</p>`;
                }
            } catch (error) {
                console.error('Error generating topic note:', error);
                scratchpad.innerHTML = '<p>An error occurred while generating the custom note.</p>';
            } finally {
                noteLoader.style.display = 'none';
            }
        });

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const question = chatInput.value.trim();
            if (!question) return;

            addMessage(question, 'user');
            chatHistory.push({ role: 'user', content: question });
            chatInput.value = '';
            addMessage('Thinking...', 'bot', true);

            try {
                const response = await fetch(`/ask-chatbot/${projectId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    question: question,
                    source_id: selectedSourceId, 
                    history: chatHistory.slice(0, -1)
                    })
                });
                const data = await response.json();
                const thinkingBubble = document.getElementById('thinking-bubble');
                if (thinkingBubble) { thinkingBubble.parentElement.remove(); }
                const answer = data.answer || data.error || "Sorry, something went wrong.";
                addMessage(answer, 'bot');
                chatHistory.push({ role: 'bot', content: answer });
            } catch (error) { console.error("Chatbot fetch error:", error); }
        });

        function addMessage(text, sender, isThinking = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}-message`;
            const p = document.createElement('p');
            if (sender === 'bot') {
                 p.innerHTML = text;
            } else {
                 p.textContent = text;
            }
            if (isThinking) p.id = 'thinking-bubble';
            messageDiv.appendChild(p);
            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function resetChat() {
            chatHistory = [];
            chatWindow.innerHTML = '';
        }

        loadSources();
    });
    </script>

    <script>

        document.addEventListener('DOMContentLoaded', () => {

        // --- DRAWER/COLLAPSE LOGIC ---
        document.querySelectorAll('.drawer-toggle').forEach(toggle => {
            toggle.addEventListener('click', () => {
                const targetPanelClass = toggle.dataset.target;
                const panel = document.querySelector(`.${targetPanelClass}`);
                
                panel.classList.toggle('collapsed');
                
                // Change the arrow direction based on the collapsed state
                if (panel.classList.contains('collapsed')) {
                    toggle.innerHTML = targetPanelClass === 'left-panel' ? '&rarr;' : '&larr;';
                } else {
                    toggle.innerHTML = targetPanelClass === 'left-panel' ? '&larr;' : '&rarr;';
                }
            });
        });

        // --- RESIZE LOGIC ---
        document.querySelectorAll('.resizer[data-resizer-type="x"]').forEach(resizer => {
            let prevPanel = resizer.previousElementSibling;
            let nextPanel = resizer.nextElementSibling;
            let isResizing = false;

            resizer.addEventListener('mousedown', (e) => {
                // Prevent default drag behavior
                e.preventDefault();
                isResizing = true;
                document.body.classList.add('resizing');

                const handleMouseMove = (moveEvent) => {
                    if (!isResizing) return;

                    const container = resizer.parentElement;
                    const containerRect = container.getBoundingClientRect();

                    // Calculate new widths based on mouse position relative to the container
                    const newPrevPanelWidth = moveEvent.clientX - prevPanel.getBoundingClientRect().left;
                    
                    // Adjust for the total flex basis, ensuring they always add up correctly
                    const totalFlexBasis = parseFloat(prevPanel.style.flexBasis) + parseFloat(nextPanel.style.flexBasis);
                    const newNextPanelWidth = (prevPanel.offsetWidth + nextPanel.offsetWidth) - newPrevPanelWidth;

                    // Respect min-width constraints (parsed from CSS)
                    const prevMinWidth = parseInt(getComputedStyle(prevPanel).minWidth, 10);
                    const nextMinWidth = parseInt(getComputedStyle(nextPanel).minWidth, 10);
                    
                    if (newPrevPanelWidth > prevMinWidth && newNextPanelWidth > nextMinWidth) {
                        // Use flex-basis for better control in a flex layout
                        prevPanel.style.flex = `0 0 ${newPrevPanelWidth}px`;
                        nextPanel.style.flex = `0 0 ${newNextPanelWidth}px`;
                    }
                };

                const handleMouseUp = () => {
                    isResizing = false;
                    document.body.classList.remove('resizing');
                    // IMPORTANT: Remove listeners from the document to stop tracking
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                };

                // Attach listeners to the document to capture mouse movement anywhere on the page
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
            });
        });
    });
    
    </script>

</body>
</html>