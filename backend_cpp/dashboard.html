<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CodeMinds Mission Control</title>
    <style>
        :root {
            --bg-color: #0d1117; --panel-bg: #161b22; --border: #30363d;
            --text-main: #c9d1d9; --accent: #58a6ff;
            --green: #2ea043; --yellow: #d29922; --red: #f85149;
            --blue: #3498db;
        }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: 'Segoe UI', monospace; margin: 0; padding: 20px; overflow: hidden; height: 100vh; box-sizing: border-box; }
        
        .grid-container { display: grid; grid-template-columns: 320px 1fr 400px; gap: 20px; height: calc(100vh - 40px); }
        
        .sidebar { display: flex; flex-direction: column; gap: 20px; overflow: hidden; }
        .main-view { display: flex; flex-direction: column; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; padding: 15px; overflow: hidden; }
        .inspector-view { display: flex; flex-direction: column; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; padding: 15px; overflow: hidden; }
        
        .panel { background: var(--panel-bg); border: 1px solid var(--border); border-radius: 8px; padding: 15px; }
        
        h2 { margin: 0 0 15px 0; font-size: 12px; text-transform: uppercase; color: #8b949e; letter-spacing: 1px; display: flex; justify-content: space-between; align-items: center;}
        
        /* GAUGE STYLING */
        .gauge-container { margin-bottom: 12px; }
        .gauge-label { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 11px; font-weight: bold; }
        .progress-track { background: #21262d; height: 4px; border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; transition: width 0.3s ease; }

        /* TRACE LIST STYLING */
        .trace-list { overflow-y: auto; flex: 1; padding-right: 5px; }
        .trace-item { 
            padding: 10px; border-left: 3px solid var(--accent); 
            background: #0d1117; margin-bottom: 8px; border-radius: 0 4px 4px 0;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
        
        .latency-tag { float: right; font-family: monospace; color: var(--accent); font-size: 10px; }
        .phase-tag { font-size: 9px; font-weight: bold; padding: 2px 6px; border-radius: 3px; text-transform: uppercase; }
        
        /* LOGS */
        #log-list { overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .log-entry { padding: 10px; background: #0d1117; border: 1px solid var(--border); border-radius: 4px; cursor: pointer; font-size: 12px; }
        .log-entry:hover { border-color: var(--accent); background: #161b22; }

        /* INSPECTOR */
        .detail-box { overflow-y: auto; flex: 1; padding: 10px; font-family: 'Consolas', monospace; font-size: 12px; border-top: 1px solid var(--border); }
        .section-header { color: var(--accent); margin: 15px 0 5px 0; font-weight: bold; font-size: 11px; text-transform: uppercase; }
        .raw-text { white-space: pre-wrap; color: #e6edf3; background: #0d1117; padding: 8px; border-radius: 4px; border: 1px solid var(--border); }

        /* PHASE COLORS */
        .RETRIEVAL { border-color: var(--blue) !important; color: var(--blue); }
        .REFLECTION { border-color: var(--yellow) !important; color: var(--yellow); }
        .TOOL_CALL { border-color: var(--red) !important; color: var(--red); }
        .GENERATION { border-color: var(--green) !important; color: var(--green); }

        /* STATUS PULSE */
        .status-pulse { width: 8px; height: 8px; border-radius: 50%; background: var(--green); display: inline-block; box-shadow: 0 0 8px var(--green); animation: pulse 2s infinite; }

        /* Phase specific pulse for Web Search */
        .WEB_SEARCHING { border-color: #00f2ff !important; color: #00f2ff; box-shadow: 0 0 10px #00f2ff33; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div class="grid-container">
        <!-- LEFT: SYSTEM VITALITY -->
        <div class="sidebar">
            <div class="panel">
                <h2>System Health <span class="status-pulse"></span></h2>
                <div class="gauge-container">
                    <div class="gauge-label"><span>CPU Usage</span><span id="cpu-val">0%</span></div>
                    <div class="progress-track"><div id="cpu-bar" class="progress-fill"></div></div>
                </div>
                <div class="gauge-container">
                    <div class="gauge-label"><span>RAM (Private)</span><span id="ram-val">0 MB</span></div>
                    <div class="progress-track"><div id="ram-bar" class="progress-fill"></div></div>
                </div>
            </div>

            <div class="panel">
                <h2>Engine Latency</h2>
                <div class="gauge-container">
                    <div class="gauge-label"><span>Vector Retrieval</span><span id="vec-val">0 ms</span></div>
                    <div class="progress-track"><div id="vec-bar" class="progress-fill"></div></div>
                </div>
                <div class="gauge-container">
                    <div class="gauge-label"><span>AI Reflection</span><span id="llm-val">0 ms</span></div>
                    <div class="progress-track"><div id="llm-bar" class="progress-fill"></div></div>
                </div>
                <div class="gauge-container">
                    <div class="gauge-label"><span>Throughput</span><span id="tps-val">0 T/s</span></div>
                    <div class="progress-track"><div id="tps-bar" class="progress-fill"></div></div>
                </div>
            </div>

            <div class="panel" style="flex: 1; display: flex; flex-direction: column;">
                <h2>History</h2>
                <div id="log-list"></div>
            </div>
        </div>

        <!-- CENTER: LIVE FLIGHT TRACE -->
        <div class="main-view">
            <h2>ðŸš€ Live Flight Trace <span id="trace-count" style="font-size:10px; color:#555">0 EVENTS</span></h2>
            <div id="trace-container" class="trace-list">
                <div style="text-align: center; color: #444; margin-top: 100px;">Waiting for Agentic Loop...</div>
            </div>
        </div>

        <!-- RIGHT: DEEP INSPECTOR -->
        <div class="inspector-view">
            <h2>Deep Analysis Inspector</h2>
            <div id="inspector" class="detail-box">
                <div style="text-align: center; color: #444; margin-top: 100px;">Select entry to inspect context.</div>
            </div>
        </div>
    </div>

    <div class="panel" id="test-control">
        <h2>Mission Control - Load Testing</h2>
        <div style="display: flex; gap: 10px;">
            <button onclick="triggerStressTest()" id="test-btn" style="background: var(--red); color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer;">
                ðŸ”¥ TRIGGER 10x STRESS LOAD
            </button>
            <button onclick="clearLogs()" style="background: #333; color: white; border: none; padding: 10px; border-radius: 4px;">
                ðŸ§¹ CLEAR TELEMETRY
            </button>
        </div>
        <div id="test-results" style="margin-top: 15px; font-size: 11px; font-family: monospace;">
            Waiting for test ignition...
        </div>
    </div>

    <script>
        let lastTraceCount = 0;

        async function updateAgentTrace() {
            try {
                const res = await fetch('/api/admin/agent_trace');
                const data = await res.json();
                
                if (data.length === lastTraceCount) return; // Prevent flicker
                lastTraceCount = data.length;
                document.getElementById('trace-count').innerText = `${data.length} EVENTS`;

                const container = document.getElementById('trace-container');
                // Newest on top
                container.innerHTML = data.slice().reverse().map(t => `
                    <div class="trace-item ${t.state}">
                        <span class="latency-tag">${t.duration.toFixed(1)}ms</span>
                        <div class="phase-tag">${t.state}</div>
                        <div style="font-size:13px; margin-top:6px; color:#c9d1d9">${t.detail}</div>
                        <div style="font-size:10px; color:#555; margin-top:4px">ID: ${t.session_id.substring(0,8)}</div>
                    </div>
                `).join('');
            } catch (e) { console.error("Trace Fetch Error", e); }
        }

        async function fetchTelemetry() {
            try {
                const res = await fetch('/api/admin/telemetry');
                const data = await res.json();
                
                updateGauge('cpu', data.metrics.cpu, 100, '%');
                updateGauge('ram', data.metrics.ram_mb, 1024, 'MB'); // Assuming 1GB scale
                updateGauge('vec', data.metrics.vector_latency, 500, 'ms');
                updateGauge('llm', data.metrics.llm_latency, 5000, 'ms');
                updateGauge('tps', data.metrics.tps, 100, 'T/s', true);
                
                renderLogs(data.logs);
            } catch (e) { console.error("Telem Fetch Error", e); }
        }

        function updateGauge(id, val, max, unit, inverse = false) {
            const elVal = document.getElementById(id + '-val');
            const elBar = document.getElementById(id + '-bar');
            if(elVal && elBar) {
                elVal.innerText = val.toFixed(0) + ' ' + unit;
                const percent = Math.min((val / max) * 100, 100);
                elBar.style.width = percent + '%';
                elBar.style.backgroundColor = getColor(percent, inverse);
            }
        }

        function getColor(percent, inverse) {
            if (inverse) return percent > 50 ? 'var(--green)' : percent > 20 ? 'var(--yellow)' : 'var(--red)';
            return percent < 50 ? 'var(--green)' : percent < 80 ? 'var(--yellow)' : 'var(--red)';
        }

        function renderLogs(logs) {
            const container = document.getElementById('log-list');
            if (!logs || logs.length === 0) return;
            
            container.innerHTML = logs.map(log => `
                <div class="log-entry" onclick='inspect(${JSON.stringify(log).replace(/'/g, "&apos;")})'>
                    <div class="log-meta">
                        <span class="badge ${log.ai_response ? 'GENERATION' : 'RETRIEVAL'}">
                            ${log.ai_response ? 'REPLY' : 'QUERY'}
                        </span>
                        <span>${new Date(log.timestamp * 1000).toLocaleTimeString()}</span>
                    </div>
                    <div class="log-prompt" title="${escapeHtml(log.user_query)}">
                        ${escapeHtml(log.user_query.substring(0, 50))}...
                    </div>
                </div>
            `).join('');
        }

        async function triggerStressTest() {
            const btn = document.getElementById('test-btn');
            btn.innerText = "ðŸš¨ SIMULATING RE-ENTRY...";
            btn.disabled = true;
            
            // Calls the C++ Backend to simulate high-concurrency tool usage
            const res = await fetch('/api/admin/stress_test', { method: 'POST' });
            const data = await res.json();
            
            document.getElementById('test-results').innerHTML = 
                `<div style="color:var(--green)">SUCCESS: ${data.passed} missions launched.</div>` +
                `<div style="color:var(--yellow)">Jitter: ${data.jitter_ms}ms</div>`;
            
            btn.innerText = "ðŸ”¥ TRIGGER 10x STRESS LOAD";
            btn.disabled = false;
        }

        function inspect(log) {
            const view = document.getElementById('inspector');
            const userSize = log.user_query.length;
            const systemSize = log.full_prompt.length;
            const amplification = (systemSize / userSize).toFixed(1);

            view.innerHTML = `
                <div class="section-header">Performance Metrics</div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; font-size:11px;">
                    <div class="panel" style="padding:8px">Latency: <b>${log.duration_ms.toFixed(0)}ms</b></div>
                    <div class="panel" style="padding:8px">RAG Gain: <b>${amplification}x</b></div>
                </div>

                <div class="section-header">User Intent</div>
                <div class="raw-text" style="border-left: 3px solid var(--green)">${escapeHtml(log.user_query)}</div>
                
                <div class="section-header">Experience Vault Tags</div>
                <div style="font-size:10px; color:#8b949e">
                    ${log.full_prompt.includes("### PREVIOUS FIX") ? '<span style="color:var(--green)">âœ“ Fix Patterns Loaded</span>' : 'No history matches found.'}
                </div>

                <div class="section-header">AI Payload (Compressed Topology)</div>
                <div class="raw-text" style="font-size:10px; height:150px; overflow-y:auto; color:#888;">${escapeHtml(log.full_prompt)}</div>

                <div class="section-header">Final AI Solution</div>
                <div class="raw-text" style="border-left: 3px solid var(--accent)">${escapeHtml(log.ai_response)}</div>
            `;
        }

        function escapeHtml(text) {
            return text ? text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : "";
        }

        async function updateToolStats() {
            const res = await fetch('/api/admin/telemetry');
            const data = await res.json();
            
            // Filter traces for TOOL_CALL states
            const toolCalls = data.agent_traces.filter(t => t.state === "TOOL_CALL");
            const counts = {};
            toolCalls.forEach(t => {
                const name = t.detail.split(':')[1].trim();
                counts[name] = (counts[name] || 0) + 1;
            });

            // Update UI (e.g., a simple list of counts)
            document.getElementById('tool-stats').innerHTML = Object.entries(counts)
                .map(([name, count]) => `<div>${name}: <b>${count} calls</b></div>`)
                .join('');
        }

        setInterval(fetchTelemetry, 1000);
        setInterval(updateAgentTrace, 1000);
    </script>
</body>
</html>